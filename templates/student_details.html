{% extends 'base.html' %}

{% block content %}
<div class="details-card">
    <h2>Student Details: {{ student.name }}</h2>

    <div class="student-info">
        <div class="detail-item"><strong>Registration No:</strong> <span>{{ student.reg_no }}</span></div>
        <div class="detail-item"><strong>Name:</strong> <span>{{ student.name }}</span></div>
        <div class="detail-item"><strong>Date of Birth:</strong> <span>{{ student.date_of_birth }}</span></div>
        <div class="detail-item"><strong>Class:</strong> <span>{{ student.class }}</span></div>
        <div class="detail-item"><strong>Current Term:</strong> <span>{{ student.term }}</span></div>
        <div class="detail-item"><strong>Academic Year:</strong> <span>{{ student.academic_year }}</span></div>
        <div class="detail-item"><strong>Guardian Name:</strong> <span>{{ student.guardian_name | d('N/A') }}</span></div>
        <div class="detail-item"><strong>Guardian Phone:</strong> <span>{{ student.guardian_phone | d('N/A') }}</span></div>
        <div class="detail-item"><strong>Last Updated:</strong> <span>{{ student.last_updated }}</span></div>
        <div class="detail-item">
            <strong>Current Fee Status:</strong>
            <span><span class="status-badge {{ current_fee_status.replace(' ', '') }}">{{ current_fee_status }}</span></span>
        </div>
        <div class="detail-item"><strong>Current Outstanding Fee:</strong> <span>₦{{ current_outstanding | format_currency }}</span></div>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid var(--border-color);">

    <div class="fee-breakdown">
        <h3>Fee Breakdown by Term</h3>
        {% if fee_breakdown %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Term</th>
                            <th>Academic Year</th>
                            <th>Expected (₦)</th>
                            <th>Paid (₦)</th>
                            <th>Outstanding (₦)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee in fee_breakdown %}
                            {% set outstanding = fee.expected_amount - fee.paid_amount %}
                            <tr>
                                <td>{{ fee.term }}</td>
                                <td>{{ fee.academic_year }}</td>
                                <td>₦{{ fee.expected_amount | format_currency }}</td>
                                <td>₦{{ fee.paid_amount | format_currency }}</td>
                                <td class="{% if outstanding > 0 %}defaulter-cell{% else %}paid-cell{% endif %}">₦{{ max(0, outstanding) | format_currency }}</td>
                                <td>
                                    {% if outstanding <= 0 %}
                                        <span class="status-badge Paid">Paid</span>
                                    {% elif fee.paid_amount > 0 %}
                                        <span class="status-badge Partially">Partially Paid</span>
                                    {% else %}
                                        <span class="status-badge Defaulter">Defaulter</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No fee breakdown available for this student.</p>
        {% endif %}
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid var(--border-color);">

    <div class="payment-history">
        <h3>Payment History</h3>
        {% if payment_history %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Payment Date</th>
                            <th>Term</th>
                            <th>Academic Year</th>
                            <th>Amount Paid (₦)</th>
                            <th>Recorded By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in payment_history %}
                            <tr>
                                <td>{{ payment.payment_date }}</td>
                                <td>{{ payment.term }}</td>
                                <td>{{ payment.academic_year }}</td>
                                <td>₦{{ payment.amount_paid | format_currency }}</td>
                                <td>{{ payment.recorded_by | d('N/A') }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No payment history available for this student.</p>
        {% endif %}
    </div>

    <div class="actions" style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="{{ url_for('edit_student', student_id=student.id) }}" class="btn btn-primary">Edit Student</a>
        <a href="{{ url_for('record_payment', student_id=student.id) }}" class="btn btn-success">Record Payment</a>
        {% if session.role == 'admin' %}
            <form action="{{ url_for('delete_student', student_id=student.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this student and all associated records? This cannot be undone!');">
                <button type="submit" class="btn btn-danger">Delete Student</button>
            </form>
        {% endif %}
        <a href="{{ url_for('student_list') }}" class="btn btn-secondary">Back to List</a>
    </div>
</div>
{% endblock %}

